parameters:
  dashboard-name:
    type: string
    default: dashboard
    description: |
      Name of the json(net) dashboard file. It is assumed that they share the same name.
      Defaults to 'dashboard'.
  dashboard-path:
    type: string
    default: monitoring
    description: |
      Specify the path to where json dashboard is available. Omit any trailing /.
      Defaults to 'monitoring'.
  folder-uid:
    type: string
    description: |
      Folder uid from Grafana.
      Uid can be taken from 'HOST/dashboards/f/{UID}'
  is-update:
    type: env_var_name
    default: IS_UPDATE
steps:
  - run:
      name: Update remote dashboard
      working_directory: <<parameters.dashboard-path>>
      command: |
        if [[ "1" == <<parameters.is-update>> ]]; then
          echo "Updating remote dashboard"

          GIT_COMMIT_DESC="$(git log --format=oneline -n 1 $CIRCLE_SHA1)"
          BODY="{
                \"dashboard\": $(jq . <<parameters.dashboard-name>>.json),
                \"folderUid\": \"<<parameters.folder-uid>>\",
                \"overwrite\": true,
                \"message\": \"$GIT_COMMIT_DESC\"
          }"
          echo $(curl $GRAFANA_DASHBOARDS_HOST/api/dashboards/db -d "$BODY" \
                -H "Authorization: Bearer $GRAFANA_DASHBOARDS_KEY" \
                -H "Content-type: application/json")
          exit $?
        fi
